on:
  push:
    branches: [ "main", "master" ]
  pull_request:
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest
    timeout-minutes: 60
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure GNU Make (gmake) is available and create compatibility symlink
        run: |
          brew update
          brew install make
          # make installs GNU Make as `gmake`. Create /usr/local/bin/gmake so Xcode's absolute path works.
          sudo mkdir -p /usr/local/bin
          sudo ln -sf "$(which gmake)" /usr/local/bin/gmake
          echo "gmake -> $(which gmake)"

      # Optional: patch project to remove hardcoded /usr/local/bin/gmake (makes repo portable)
      - name: Patch project to use "gmake" instead of hardcoded /usr/local/bin/gmake
        run: |
          # Only attempt if project file exists
          PBX="PojavPatch/PojavPatch.xcodeproj/project.pbxproj"
          if [ -f "$PBX" ]; then
            sed -i '' 's|/usr/local/bin/gmake|gmake|g' "$PBX" || sed -i 's|/usr/local/bin/gmake|gmake|g' "$PBX"
            git --no-pager diff -- "$PBX" || true
          else
            echo "$PBX not present; skipping project patch"
          fi

      - name: (Optional) Install CocoaPods dependencies
        if: exists('Podfile')
        run: |
          brew install cocoapods || true
          cd "$(dirname Podfile)"
          pod install --repo-update

      - name: Build (xcodebuild)
        run: |
          # Adjust project/workspace/scheme/name as needed for this repo
          # This example uses the PojavPatch project and PojavPatch scheme from the error you showed
          xcodebuild -project PojavPatch/PojavPatch.xcodeproj \
            -scheme PojavPatch \
            -configuration Release \
            -sdk macosx \
            build \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO

      - name: Upload logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: xcodebuild-logs
          path: |
            /Users/runner/Library/Logs/DiagnosticReports
            ~/Library/Developer/Xcode/DerivedData
